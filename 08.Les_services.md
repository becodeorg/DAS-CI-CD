# Les services

Lorsque vous configurez CI/CD, vous spécifiez une image, qui est utilisée pour créer le conteneur dans lequel vos tâches s'exécutent. Pour spécifier cette image, vous utilisez le mot-clé ``ìmage``.

Vous pouvez spécifier une image supplémentaire en utilisant le mot-clé ``servicves``. Cette image supplémentaire est utilisée pour créer un autre conteneur, disponible pour le premier conteneur. Les deux conteneurs ont accès l'un à l'autre et peuvent communiquer lors de l'exécution du travail.

```yaml
variables:
  DOCKER_TLS_CERTDIR: ""
  FF_NETWORK_PER_BUILD: "true"
  POSTGRES_DB: postgres
  POSTGRES_USER: runner
  POSTGRES_PASSWORD: postgres
  POSTGRES_HOST_AUTH_METHOD: trust
stages:    
  - test
Testing:
  stage: test
  image: debian:latest
  services:
    - postgres
  script:
    - apt update && apt install -y postgresql-client
    - PGPASSWORD=$POSTGRES_PASSWORD psql -U $POSTGRES_USER -h postgres -d postgres -c "\l"
  tags:
  - docker
```

Les services sont des conteneurs Docker qui peuvent être liés à vos jobs pour 
fournir des dépendances ou des services nécessaires à l'exécution de vos tests ou de votre pipeline. 

L'utilisation de services est particulièrement utile lorsque vous souhaitez isoler votre job 
et ses dépendances sans avoir à installer ces dépendances directement sur le runner. 
Les services peuvent être démarrés avant l'exécution du job et arrêtés après son achèvement.

Il est également possible d'utiliser plueirurs services avec différentes versions. 

```yaml
variables:
  DOCKER_TLS_CERTDIR: ""
  FF_NETWORK_PER_BUILD: "true"
  POSTGRES_DB: postgres
  POSTGRES_USER: runner
  POSTGRES_PASSWORD: postgres
  POSTGRES_HOST_AUTH_METHOD: trust
Testing:
  stage: test
  image: debian:latest
  services:
    - name: postgres:14.1-alpine
      alias: mydb1
    - name: postgres:10.19-stretch
      alias: mydb2
    - name: postgres:9-alpine3.14
      alias: mydb3
  script:
    - apt update && apt install -y postgresql-client
    - PGPASSWORD=$POSTGRES_PASSWORD psql -U $POSTGRES_USER -h mydb1 -d postgres -c "SELECT version();"
    - PGPASSWORD=$POSTGRES_PASSWORD psql -U $POSTGRES_USER -h mydb2 -d postgres -c "SELECT version();"
    - PGPASSWORD=$POSTGRES_PASSWORD psql -U $POSTGRES_USER -h mydb3 -d postgres -c "SELECT version();"
  tags:
  - docker
```

Example avec mysql :

```yaml
variables:
  DOCKER_TLS_CERTDIR: ""
  FF_NETWORK_PER_BUILD: "true"
  MYSQL_DATABASE: "db_name"
  MYSQL_ROOT_PASSWORD: "dbpass"
  MYSQL_USER: "username"
  MYSQL_PASSWORD: "dbpass"
  MYSQL_HOST: mysql
stages:    
  - test
Testing:
  image: debian:latest
  services:
    - mysql
  stage: test
  script:
    - apt update && apt install -y mariadb-client
    - echo "SHOW tables;" | mysql -u root -p"$MYSQL_ROOT_PASSWORD" -h mysql "${MYSQL_DATABASE}"
    - echo "CREATE TABLE das (field1 int);" | mysql -u root -p"$MYSQL_ROOT_PASSWORD" -h mysql "${MYSQL_DATABASE}"
    - echo "SHOW tables;" | mysql -u root -p"$MYSQL_ROOT_PASSWORD" -h mysql "${MYSQL_DATABASE}"
  tags: 
    - docker
```

Et un autre avec Nginx :
```yaml
variables:
  DOCKER_TLS_CERTDIR: ""
  FF_NETWORK_PER_BUILD: "true"
stages:
  - test
Testing:
  stage: test
  image: debian:latest
  services:
    - name: nginx:latest
      alias: mynginx
  script:
    - apt update -qq 2>&1 >/dev/null && apt -qq install -y curl 2>&1 >/dev/null
    - curl mynginx
  tags:
  - docker
```
